name: Debug and Run Bot

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"
    - cron: "0 5 * * *"
    - cron: "0 9 * * *"
    - cron: "0 13 * * *"

jobs:
  debug-and-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      # ---------- DEBUG: check that secrets are injected ----------
      - name: Debug (check which secrets are present)
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
          BIBLE_API_URL: ${{ secrets.BIBLE_API_URL }}
        run: |
          echo "TWITTER_API_KEY: ${TWITTER_API_KEY:+SET}"
          echo "TWITTER_API_SECRET: ${TWITTER_API_SECRET:+SET}"
          echo "TWITTER_ACCESS_TOKEN: ${TWITTER_ACCESS_TOKEN:+SET}"
          echo "TWITTER_ACCESS_SECRET: ${TWITTER_ACCESS_SECRET:+SET}"
          echo "BEARER_TOKEN: ${BEARER_TOKEN:+SET}"
          echo "BIBLE_API_URL: ${BIBLE_API_URL:+SET}"
          echo "(If any line is blank, that secret isn't injected)"

      # ---------- QUICK AUTH CHECK against Twitter API ----------
      - name: Quick Twitter auth check
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          node -e "const { TwitterApi } = require('twitter-api-v2');
          const client = new TwitterApi({
            appKey: process.env.TWITTER_API_KEY,
            appSecret: process.env.TWITTER_API_SECRET,
            accessToken: process.env.TWITTER_ACCESS_TOKEN,
            accessSecret: process.env.TWITTER_ACCESS_SECRET,
          });
          client.v2.me()
            .then(u => console.log('✅ TWITTER AUTH OK - connected as @' + u.data.username))
            .catch(e => { console.error('❌ TWITTER AUTH ERROR: ' + e.message); process.exit(1); });"

      # ---------- RUN YOUR BOT ----------
      - name: Run bot (post image)
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
          BIBLE_API_URL: ${{ secrets.BIBLE_API_URL }}
          NODE_ENV: production
        run: node index.js
